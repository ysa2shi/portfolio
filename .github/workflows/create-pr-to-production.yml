name: Create PR to production

on:
  push:
    branches:
      - master

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr-if-needed:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout master branch
        uses: actions/checkout@v3
        with:
          ref: master
          fetch-depth: 0  # 差分チェックに必要

      - name: Set up Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Check diff between master and production
        id: diffcheck
        run: |
          git fetch origin production
          git diff --quiet origin/production...HEAD || echo "has_diff=true" >> $GITHUB_OUTPUT

      - name: Get current JST date
        if: steps.diffcheck.outputs.has_diff == 'true'
        id: date
        run: |
          echo "date=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S (JST)')" >> $GITHUB_OUTPUT

      - name: Create PR to production
        if: steps.diffcheck.outputs.has_diff == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: production
          branch: master
          title: 'Merge master into production - ${{ steps.date.outputs.date }}'
          body: |
            This pull request was automatically generated by GitHub Actions.
            **Created at (JST)**: ${{ steps.date.outputs.date }}
          draft: false
